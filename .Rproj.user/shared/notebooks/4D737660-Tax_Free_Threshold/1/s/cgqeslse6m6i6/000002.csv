"0","#-----------------------------------------------------------------------------------------------------"
"0","#              Calculate _average taxable income_ and _total income or loss_ per cohort              -"
"0","#   Add personal income tax payable with (pit_tft) and without (pit_no_tft) the tax free threshold   -"
"0","#                           Remove letters preceding age cohort descriptors                          -"
"0","#-----------------------------------------------------------------------------------------------------"
"0",""
"0","indiv_tax_stats <- indiv_tax_stats_raw %>%"
"0","  mutate("
"0","    #variable created to break the total down to the individual level"
"0","    avg_sal_and_wage = salary_or_wages / salary_or_wages_no,"
"0",""
"0","    # Adding variable calculating gross tax liability with the tft"
"0","    # pit_tft includes current tft settings"
"0","    pit_tft = case_when("
"0","      avg_sal_and_wage <= 18200  ~ 0,"
"0","      avg_sal_and_wage <= 37000  ~ ((avg_sal_and_wage - 18201) * 0.1900),"
"0","      avg_sal_and_wage <= 90000  ~ ((avg_sal_and_wage - 37001) * 0.3250) + 3572,"
"0","      avg_sal_and_wage <= 180000 ~ ((avg_sal_and_wage - 90001) * 0.3700) + 20797,"
"0","      TRUE ~ ((avg_sal_and_wage - 180001) * 0.4500) + 54097),"
"0",""
"0","    # Adding an additional factor to show which tax bracket this cohort fall into and factoring properly"
"0","    bracket = case_when("
"0","      avg_sal_and_wage <= 18200  ~ ""$0 - $18,200"","
"0","      avg_sal_and_wage <= 37000  ~ ""$18,201 - $37,000"","
"0","      avg_sal_and_wage <= 90000  ~ ""$37,001 - $90,000"","
"0","      avg_sal_and_wage <= 180000 ~ ""$90,001 - $180,000"","
"0","      TRUE ~ ""$180,001 and over"""
"0","    ) %>% factor(levels = c(""$0 - $18,200"", ""$18,201 - $37,000"", ""$37,001 - $90,000"", ""$90,001 - $180,000"", ""$180,001 and over""), ordered = TRUE),"
"0",""
"0","    # Adding variable calculating fross tax liability without the tft"
"0","    pit_no_tft = case_when("
"0","      avg_sal_and_wage <= 37000 ~ (avg_sal_and_wage * 0.1900),"
"0","      avg_sal_and_wage <= 90000 ~ ((avg_sal_and_wage - 37001) * 0.3250) + 7030,"
"0","      avg_sal_and_wage <= 180000 ~ ((avg_sal_and_wage - 90001) * 0.3700) + 24255,"
"0","      TRUE ~ ((avg_sal_and_wage - 180001) * 0.4500) + 57555),"
"0",""
"0","    # Refactoring the age range variable to play nicely in r"
"0","    age_range           = factor(str_remove_all(age_range, pattern = ""[a-z][.] ""), ordered = TRUE) %>% fct_shift(n = -1L),"
"0","    pit_tft_diff        = pit_no_tft - pit_tft,"
"0",""
"0","    #These variables build up the individual level calculations to a total level using the number of taxpayers in each cohort"
"0","    total_pit_tft       = pit_tft * salary_or_wages_no,"
"0","    total_pit_no_tft    = pit_no_tft * salary_or_wages_no,"
"0","    total_pit_tft_diff  = pit_tft_diff * salary_or_wages_no"
"0","  ) %>%"
"0","  select(1, 3:6, avg_sal_and_wage, bracket, number_of_individuals_no, pit_tft, pit_no_tft, pit_tft_diff, salary_or_wages, salary_or_wages_no, total_pit_tft, total_pit_no_tft, total_pit_tft_diff)"
"0",""
